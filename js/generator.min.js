$.extend($.importexport.plugins,{generator:{$form:null,progress:!1,ajax_pull:{},data:{params:{}},debug:{memory:0,memory_avg:0},init:function(r){$.shop.trace("init data",r),this.$form=$("#s-plugin-generator"),$.extend(this.data,r),$(".type select",this.$form).on("change",function(){var r=$(".feature",this.$form);r.hide(),r.filter(".feature-type"+$(this).val()).show()}).trigger("change")},action:function(){},onInit:function(){$.importexport.products.init(this.$form),this.$form.unbind("submit.generator").bind("submit.generator",function(r){return $.shop.trace("submit.generator "+r.namespace,r),$.importexport.plugins.generator.generatorHandler(this),!1})},actionHandler:function(r){return $.shop.trace("actionHadler arg",r),!1},select:function(r,e){var o=$(r).find("span.name").text();$("#s-plugin-generator-cat").val(o),$("#s-plugin-generator-catid").val(e)},checkFeature:function(r,e){$(r).prop("checked")?$(".fid"+e).attr("disabled",!1):$(".fid"+e).attr("disabled",!0)},generatorHandler:function(r){var e=this;e.progress=!0,e.form=$(r);var o=e.form.serialize(),s=$(r).attr("action");$.shop.trace("elm",r),e.form.find(".errormsg").text(""),e.form.find(":input").prop("disabled",!0),e.form.find(":submit").hide(),e.form.find(".progressbar .progressbar-inner").css("width","0"),e.form.find(".progressbar").show(),e.form.find("#plugin-generator-report").hide(),$.ajax({url:s,data:o,dataType:"json",type:"post",success:function(r){r.error?(e.form.find(":input").prop("disabled",!1),e.form.find(".ftrs").prop("disabled",!0),e.form.find(".fcheck").prop("checked",!1),e.form.find(":submit").show(),e.form.find(".js-progressbar-container").hide(),e.form.find(".shop-ajax-status-loading").remove(),e.progress=!1,e.form.find(".errormsg").text(r.error)):(e.form.find(".progressbar").attr("title","0.00%"),e.form.find(".progressbar-description").text("0.00%"),e.form.find(".js-progressbar-container").show(),e.ajax_pull[r.processId]=[],e.ajax_pull[r.processId].push(setTimeout(function(){$.wa.errorHandler=function(r){return!(500<=r.status||0==r.status)},e.progressHandler(s,r.processId,r)},100)),e.ajax_pull[r.processId].push(setTimeout(function(){e.progressHandler(s,r.processId,null)},2e3)))},error:function(){e.form.find(":input").attr("disabled",!1),e.form.find(".ftrs").prop("disabled",!0),e.form.find(".fcheck").prop("checked",!1),e.form.find(":submit").show(),e.form.find(".js-progressbar-container").hide(),e.form.find(".shop-ajax-status-loading").remove(),e.form.find(".progressbar").hide()}})},progressHandler:function(e,r,o){var s,a=$.importexport.plugins.generator;if(o&&o.ready){var t;for($.wa.errorHandler=null;t=a.ajax_pull[r].pop();)t&&clearTimeout(t);(s=a.form.find(".progressbar .progressbar-inner")).css({width:"100%"}),$.shop.trace("cleanup",o.processId),$.ajax({url:e,data:{processId:o.processId,cleanup:1},dataType:"json",type:"post",success:function(r){$.shop.trace("report",r),a.form.find(".js-progressbar-container").hide();var e=$("#plugin-generator-report");e.show(),r.report&&e.find(".value:first").html(r.report),a.form.find(":input").prop("disabled",!1),a.form.find(".ftrs").prop("disabled",!0),a.form.find(".fcheck").prop("checked",!1),a.form.find(":submit").show()}})}else if(o&&o.error)a.form.find(":input").attr("disabled",!1),a.form.find(".ftrs").prop("disabled",!0),a.form.find(".fcheck").prop("checked",!1),a.form.find(":submit").show(),a.form.find(".js-progressbar-container").hide(),a.form.find(".shop-ajax-status-loading").remove(),a.form.find(".progressbar").hide(),a.form.find(".errormsg").text(o.error);else{var n;if(o&&void 0!==o.progress){s=a.form.find(".progressbar .progressbar-inner");var i=parseFloat(o.progress.replace(/,/,"."));s.animate({width:i+"%"}),a.debug.memory=Math.max(0,a.debug.memory,parseFloat(o.memory)||0),a.debug.memory_avg=Math.max(0,a.debug.memory_avg,parseFloat(o.memory_avg)||0);var p="Memory usage: "+a.debug.memory_avg+"/"+a.debug.memory+"MB";p+=" ("+(1+o.stage_num)+"/"+(0+o.stage_count)+")";var d=o.progress;s.parents(".progressbar").attr("title",o.progress),(n=a.form.find(".progressbar-description")).text(d),n.attr("title",p)}o&&void 0!==o.warning&&(n=a.form.find(".progressbar-description")).append('<i class="icon16 exclamation"></i><p>'+o.warning+"</p>");var f=e,m=r;a.ajax_pull[m].push(setTimeout(function(){$.ajax({url:f,data:{processId:m},dataType:"json",type:"post",success:function(r){a.progressHandler(e,r&&r.processId||m,r)},error:function(){a.progressHandler(e,m,null)}})},1e3))}}}});
